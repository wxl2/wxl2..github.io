<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/1.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.allhw.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="MySQL官方文档:https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;mysql-query.html">
<meta property="og:type" content="article">
<meta property="og:title" content="FlamingoServer开源代码阅读-MySql相关操作封装">
<meta property="og:url" content="https://www.allhw.top/posts/6f363257/index.html">
<meta property="og:site_name" content="allhw&#39;s blog">
<meta property="og:description" content="MySQL官方文档:https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;mysql-query.html">
<meta property="og:locale">
<meta property="article:published_time" content="2020-06-04T12:19:21.000Z">
<meta property="article:modified_time" content="2020-09-19T10:38:25.221Z">
<meta property="article:author" content="allhw">
<meta property="article:tag" content="Cpp">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="Flamingo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.allhw.top/posts/6f363257/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>FlamingoServer开源代码阅读-MySql相关操作封装 | allhw's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">allhw's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Learning log of salted fish</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.allhw.top/posts/6f363257/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.jpg">
      <meta itemprop="name" content="allhw">
      <meta itemprop="description" content="logs for me">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="allhw's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          FlamingoServer开源代码阅读-MySql相关操作封装
        </h1>

        <div class="post-meta">
		  
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-04 20:19:21" itemprop="dateCreated datePublished" datetime="2020-06-04T20:19:21+08:00">2020-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-19 18:38:25" itemprop="dateModified" datetime="2020-09-19T18:38:25+08:00">2020-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">开源代码</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>42k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>38 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="MySQL官方文档-https-dev-mysql-com-doc-refman-5-7-en-mysql-query-html"><a href="#MySQL官方文档-https-dev-mysql-com-doc-refman-5-7-en-mysql-query-html" class="headerlink" title="MySQL官方文档:https://dev.mysql.com/doc/refman/5.7/en/mysql-query.html"></a>MySQL官方文档:<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/mysql-query.html">https://dev.mysql.com/doc/refman/5.7/en/mysql-query.html</a></h4><a id="more"></a>

<h3 id="Field类"><a href="#Field类" class="headerlink" title="Field类"></a>Field类</h3><h4 id="Field-h"><a href="#Field-h" class="headerlink" title="Field.h"></a>Field.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*保存mysql字段，仅保存单行，一个示例结构</span></span><br><span class="line"><span class="comment"> *&#123;m_bNULL = false, m_strValue = &quot;information_schema&quot;, m_strFieldName = &quot;database&quot;, m_iType = Field::DB_TYPE_STRING&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">toLowerString</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span>&amp; str)</span><span class="comment">//将字符串转化为小写</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; str.size(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(str[i] &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; str[i] &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            str[i] = str[i] + (<span class="string">&#x27;a&#x27;</span> - <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">enum</span> DataTypes</span><br><span class="line">        &#123;</span><br><span class="line">            DB_TYPE_UNKNOWN = <span class="number">0x00</span>,</span><br><span class="line">            DB_TYPE_STRING  = <span class="number">0x01</span>,</span><br><span class="line">            DB_TYPE_INTEGER = <span class="number">0x02</span>,</span><br><span class="line">            DB_TYPE_FLOAT   = <span class="number">0x03</span>,</span><br><span class="line">            DB_TYPE_BOOL    = <span class="number">0x04</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Field();</span><br><span class="line">        Field(Field &amp;f);</span><br><span class="line">        Field(<span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">enum</span> DataTypes type);</span><br><span class="line"></span><br><span class="line">        ~Field();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">enum</span> DataTypes <span class="title">getType</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> m_iType; &#125;<span class="comment">//返回字段数据类型</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">getString</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span>  m_strValue; &#125;<span class="comment">//返回字段至</span></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">getCppString</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span>  m_strValue;                    <span class="comment">// std::string s = 0 have undefine result in C++</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">float</span> <span class="title">getFloat</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(atof( m_strValue.c_str())); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">getBool</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span>  atoi(m_strValue.c_str()) &gt; <span class="number">0</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">int32_t</span> <span class="title">getInt32</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span>  <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(atol(m_strValue.c_str())); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">uint8_t</span> <span class="title">getUInt8</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span>  <span class="keyword">static_cast</span>&lt;<span class="keyword">uint8_t</span>&gt;(atol(m_strValue.c_str())); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">uint16_t</span> <span class="title">getUInt16</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span>  <span class="keyword">static_cast</span>&lt;<span class="keyword">uint16_t</span>&gt;(atol(m_strValue.c_str())); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">int16_t</span> <span class="title">getInt16</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span>  <span class="keyword">static_cast</span>&lt;<span class="keyword">int16_t</span>&gt;(atol(m_strValue.c_str())); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">uint32_t</span> <span class="title">getUInt32</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span>  <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(atol(m_strValue.c_str())); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">uint64_t</span> <span class="title">getUInt64</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> value = <span class="number">0</span>;</span><br><span class="line">            value = atoll(m_strValue.c_str());</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setType</span><span class="params">(<span class="keyword">enum</span> DataTypes type)</span> </span>&#123; m_iType = type; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* value, <span class="keyword">size_t</span> uLen)</span></span>;<span class="comment">//设置字段值</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">setName</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; strName)</span><span class="comment">//设置表头值</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            m_strFieldName = strName;</span><br><span class="line">            toLowerString(m_strFieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; <span class="title">getName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> m_strFieldName;<span class="comment">//获取表头</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">isNULL</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> m_bNULL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">convertValue</span><span class="params">(T&amp; value)</span></span>;<span class="comment">//未实现</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">bool</span>                 m_bNULL;<span class="comment">//该字段是否为空标志</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span>          m_strValue;<span class="comment">//字段值</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span>          m_strFieldName;<span class="comment">//表头，字段名</span></span><br><span class="line">        <span class="keyword">enum</span> DataTypes       m_iType;<span class="comment">//字段类型</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Field-cpp"><a href="#Field-cpp" class="headerlink" title="Field.cpp"></a>Field.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Field.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Field::Field() : m_iType(DB_TYPE_UNKNOWN)</span><br><span class="line">&#123;</span><br><span class="line">    m_bNULL = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Field::Field(Field &amp;f)</span><br><span class="line">&#123;</span><br><span class="line">    m_strValue = f.m_strValue;</span><br><span class="line">    m_strFieldName = f.m_strFieldName;</span><br><span class="line"></span><br><span class="line">    m_iType = f.getType();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Field::Field(<span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">enum</span> Field::DataTypes type) : m_iType(type)</span><br><span class="line">&#123;</span><br><span class="line">    m_strValue = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Field::~Field()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Field::setValue</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">size_t</span> uLen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//m_strValue = value;</span></span><br><span class="line">    m_strValue.assign(value, uLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="QueryResult类"><a href="#QueryResult类" class="headerlink" title="QueryResult类"></a>QueryResult类</h3><h4 id="QueryResult-h"><a href="#QueryResult-h" class="headerlink" title="QueryResult.h"></a>QueryResult.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Field.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">QueryResult</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">typedef</span> <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">uint32_t</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; FieldNames;</span><br><span class="line"></span><br><span class="line">        QueryResult(MYSQL_RES* result, <span class="keyword">uint64_t</span> rowCount, <span class="keyword">uint32_t</span> fieldCount);</span><br><span class="line">        <span class="keyword">virtual</span> ~QueryResult();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">nextRow</span><span class="params">()</span></span>;<span class="comment">//设置m_CurrentRow的每个Field成员的值，并将mysql返回结果集后移到下一行</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">uint32_t</span> <span class="title">getField_idx</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name)</span> <span class="keyword">const</span><span class="comment">//传入字段名，返回其列号</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(FieldNames::const_iterator iter = getFieldNames().begin(); iter != getFieldNames().end(); ++iter)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(iter-&gt;second == name)</span><br><span class="line">                    <span class="keyword">return</span> iter-&gt;first;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">uint32_t</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Field* <span class="title">fetch</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> m_CurrentRow; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> Field &amp; <span class="keyword">operator</span> [] (<span class="keyword">int</span> index) <span class="keyword">const</span> </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">return</span> m_CurrentRow[index];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> Field&amp; <span class="keyword">operator</span> [] (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;name) <span class="keyword">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_CurrentRow[getField_idx(name)];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">uint32_t</span> <span class="title">getFieldCount</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> m_FieldCount; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">uint64_t</span> <span class="title">getRowCount</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> m_RowCount; &#125;</span><br><span class="line">        <span class="function">FieldNames <span class="keyword">const</span>&amp; <span class="title">getFieldNames</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;<span class="keyword">return</span> m_FieldNames; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; <span class="keyword">const</span>&amp; <span class="title">getNames</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;<span class="keyword">return</span> m_vtFieldNames;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="function"><span class="keyword">enum</span> Field::DataTypes <span class="title">convertNativeType</span><span class="params">(enum_field_types mysqlType)</span> <span class="keyword">const</span></span>;<span class="comment">//返回字段数据类型</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">endQuery</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        Field *                     m_CurrentRow;<span class="comment">//MySQL返回结果集数组，一个类即为结果集中的一行，只有一行，但为多列</span></span><br><span class="line">        <span class="keyword">uint32_t</span>                    m_FieldCount;<span class="comment">//当前处理行的列数</span></span><br><span class="line">        <span class="keyword">uint64_t</span>                    m_RowCount;<span class="comment">//结果集行数</span></span><br><span class="line">        FieldNames                  m_FieldNames;<span class="comment">//表头map int-string</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;    m_vtFieldNames;<span class="comment">//表头集合,连续数组</span></span><br><span class="line"></span><br><span class="line">		MYSQL_RES*                  m_Result;<span class="comment">//MySQL结果集指针</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="QueryResult-cpp"><a href="#QueryResult-cpp" class="headerlink" title="QueryResult.cpp"></a>QueryResult.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;QueryResult.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../base/AsyncLog.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">QueryResult::QueryResult(MYSQL_RES *result, <span class="keyword">uint64_t</span> rowCount, <span class="keyword">uint32_t</span> fieldCount)</span><br><span class="line"> : m_FieldCount(fieldCount), m_RowCount(rowCount)</span><br><span class="line">&#123;</span><br><span class="line">    m_Result = result;</span><br><span class="line">	m_CurrentRow = <span class="keyword">new</span> Field[m_FieldCount];</span><br><span class="line"></span><br><span class="line">     <span class="comment">//返回MYSQL_FIELD 结果集的所有结构的数组。每个结构都为结果集的一列提供字段定义。表头</span></span><br><span class="line">    MYSQL_FIELD *fields = mysql_fetch_fields(m_Result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; m_FieldCount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span> 这个地方要不要判断为NULL？</span></span><br><span class="line">		<span class="keyword">if</span> (fields[i].name != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_FieldNames[i] = fields[i].name;</span><br><span class="line">            m_vtFieldNames.push_back(fields[i].name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_FieldNames[i] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            m_vtFieldNames.push_back(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        m_CurrentRow[i].setType(convertNativeType(fields[i].type));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">QueryResult::~QueryResult(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    endQuery();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">QueryResult::nextRow</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MYSQL_ROW row;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!m_Result)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检索结果集的下一行，初始返回结过集中的row为NULL：</span></span><br><span class="line">    row = mysql_fetch_row(m_Result);</span><br><span class="line">    <span class="keyword">if</span> (!row)</span><br><span class="line">    &#123;</span><br><span class="line">        endQuery();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *ulFieldLength;</span><br><span class="line">    <span class="comment">//返回一个字段的长度，即strlen(field)</span></span><br><span class="line">    ulFieldLength = mysql_fetch_lengths(m_Result);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; m_FieldCount; i++)</span><br><span class="line">    &#123;<span class="comment">//按列设置Field结构，每个字段的值</span></span><br><span class="line">        <span class="keyword">if</span>(row[i] == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;<span class="comment">//当前列为空，即无值，将字段内容设置为空</span></span><br><span class="line">            m_CurrentRow[i].m_bNULL = <span class="literal">true</span>;</span><br><span class="line">            m_CurrentRow[i].setValue(<span class="string">&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_CurrentRow[i].m_bNULL = <span class="literal">false</span>;</span><br><span class="line">            m_CurrentRow[i].setValue(row[i], ulFieldLength[i]);<span class="comment">//设置字段值</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_CurrentRow[i].setName(m_FieldNames[i]);<span class="comment">//设置表头</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QueryResult::endQuery</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_CurrentRow)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> [] m_CurrentRow;</span><br><span class="line">        m_CurrentRow = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_Result)</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="comment">//LOGI &lt;&lt; &quot;QueryResult::EndQuery, mysql_free_result&quot;;</span></span><br><span class="line">        mysql_free_result(m_Result);</span><br><span class="line">        m_Result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">enum</span> Field::DataTypes <span class="title">QueryResult::convertNativeType</span><span class="params">(enum_field_types mysqlType)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (mysqlType)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_TIMESTAMP:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_DATE:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_TIME:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_DATETIME:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_YEAR:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_STRING:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_VAR_STRING:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_BLOB:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_SET:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_NULL:</span><br><span class="line">            <span class="keyword">return</span> Field::DB_TYPE_STRING;</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_TINY:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_SHORT:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_LONG:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_INT24:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_LONGLONG:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_ENUM:</span><br><span class="line">            <span class="keyword">return</span> Field::DB_TYPE_INTEGER;</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_DECIMAL:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_FLOAT:</span><br><span class="line">        <span class="keyword">case</span> FIELD_TYPE_DOUBLE:</span><br><span class="line">            <span class="keyword">return</span> Field::DB_TYPE_FLOAT;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> Field::DB_TYPE_UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DatabaseMysql"><a href="#DatabaseMysql" class="headerlink" title="DatabaseMysql"></a>DatabaseMysql</h3><h4 id="DatabaseMysql-h"><a href="#DatabaseMysql-h" class="headerlink" title="DatabaseMysql.h"></a>DatabaseMysql.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mysql/errmsg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;QueryResult.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_QUERY_LEN   1024</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CDatabaseMysql</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">DatabaseInfo</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">string</span> strHost;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> strUser;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> strPwd;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> strDBName;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	CDatabaseMysql(<span class="keyword">void</span>);</span><br><span class="line">	~CDatabaseMysql(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">initialize</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; host, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; user, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; pwd, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname)</span></span>;</span><br><span class="line">	<span class="function">QueryResult* <span class="title">query</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sql)</span></span>;</span><br><span class="line">	<span class="function">QueryResult* <span class="title">query</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; sql)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> query(sql.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">QueryResult* <span class="title">pquery</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *format,...)</span></span>;<span class="comment">//接受多个参数，而后拼接，执行其拼接出的sql</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">execute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* sql)</span></span>;<span class="comment">//执行sql，不获取状态，内部有做数据库是否连接判断，如果没有则会重连</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">execute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* sql, <span class="keyword">uint32_t</span>&amp; uAffectedCount, <span class="keyword">int</span>&amp; nErrno)</span></span>;<span class="comment">//执行sql获取错误码，改变集合中的行号，内部有做数据库是否连接判断，如果没有则会重连</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">pexecute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *format,...)</span></span>;<span class="comment">//接受多个参数，而后拼接，执行其拼接出的sql</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">uint32_t</span> <span class="title">getInsertID</span><span class="params">()</span></span>;<span class="comment">//返回AUTO_INCREMENT成功插入的第一个自动生成的 值。</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clearStoredResults</span><span class="params">()</span></span>;<span class="comment">//清除存储结果，清空查询所得的结果集</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int32_t</span> <span class="title">escapeString</span><span class="params">(<span class="keyword">char</span>* szDst, <span class="keyword">const</span> <span class="keyword">char</span>* szSrc, <span class="keyword">uint32_t</span> uSize)</span></span>;<span class="comment">//创建一个合法的SQL字符串以用于SQL语句</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	DatabaseInfo    m_DBInfo;</span><br><span class="line">	MYSQL*          m_Mysql;</span><br><span class="line">	<span class="keyword">bool</span>            m_bInit;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="DatabaseMysql-cpp"><a href="#DatabaseMysql-cpp" class="headerlink" title="DatabaseMysql.cpp"></a>DatabaseMysql.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DatabaseMysql.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../base/AsyncLog.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CDatabaseMysql::CDatabaseMysql(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//m_Mysql = new MYSQL;</span></span><br><span class="line">    m_Mysql = <span class="literal">NULL</span>;</span><br><span class="line">    m_bInit = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CDatabaseMysql::~CDatabaseMysql(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_Mysql != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_bInit)</span><br><span class="line">        &#123;</span><br><span class="line">            mysql_close(m_Mysql);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//delete m_Mysql;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CDatabaseMysql::initialize</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; host, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; user, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; pwd, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//LOGI &lt;&lt; &quot;CDatabaseMysql::Initialize, begin...&quot;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ClearStoredResults();</span></span><br><span class="line">    <span class="keyword">if</span> (m_bInit)</span><br><span class="line">    &#123;</span><br><span class="line">        mysql_close(m_Mysql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_Mysql = mysql_init(m_Mysql);<span class="comment">//MySQL初始化</span></span><br><span class="line">    m_Mysql = mysql_real_connect(m_Mysql, host.c_str(), user.c_str(), pwd.c_str(), dbname.c_str(), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>);<span class="comment">//和MySQL服务器建立连接</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ClearStoredResults();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//LOGI &lt;&lt; &quot;mysql info: host=&quot; &lt;&lt; host &lt;&lt; &quot;, user=&quot; &lt;&lt; user &lt;&lt; &quot;, password=&quot; &lt;&lt; pwd &lt;&lt; &quot;, dbname=&quot; &lt;&lt; dbname;</span></span><br><span class="line"></span><br><span class="line">    m_DBInfo.strDBName = dbname;</span><br><span class="line">    m_DBInfo.strHost = host;</span><br><span class="line">    m_DBInfo.strUser = user;</span><br><span class="line">    m_DBInfo.strPwd = pwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_Mysql)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//LOGI &lt;&lt; &quot;m_Mysql address &quot; &lt;&lt; (long)m_Mysql;</span></span><br><span class="line">        <span class="comment">//LOGI &lt;&lt; &quot;CDatabaseMysql::Initialize, set names utf8&quot;;</span></span><br><span class="line">        mysql_query(m_Mysql, <span class="string">&quot;set names utf8&quot;</span>);<span class="comment">//执行SQL语句，不能含有0字符</span></span><br><span class="line">        <span class="comment">//mysql_query(m_Mysql, &quot;set names latin1&quot;);</span></span><br><span class="line">        m_bInit = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//LOGE &lt;&lt; &quot;Could not connect to MySQL database at &quot; &lt;&lt; host.c_str()</span></span><br><span class="line">        <span class="comment">//    &lt;&lt; &quot;, &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">        mysql_close(m_Mysql);<span class="comment">//关闭MySQL连接</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//LOGI &lt;&lt; &quot;CDatabaseMysql::Initialize, init failed!&quot;;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> 这个函数要区分一下空数据集和出错两种情况</span></span><br><span class="line"><span class="function">QueryResult* <span class="title">CDatabaseMysql::query</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_Mysql)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//LOGI &lt;&lt; &quot;CDatabaseMysql::Query, mysql is disconnected!&quot;;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> == initialize(m_DBInfo.strHost, m_DBInfo.strUser,</span><br><span class="line">            m_DBInfo.strPwd, m_DBInfo.strDBName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!m_Mysql)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    MYSQL_RES* result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> rowCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> fieldCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//LOGI &lt;&lt; sql;</span></span><br><span class="line">        <span class="keyword">int</span> iTempRet = mysql_real_query(m_Mysql, sql, <span class="built_in">strlen</span>(sql));</span><br><span class="line">        <span class="keyword">if</span> (iTempRet)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> uErrno = mysql_errno(m_Mysql);</span><br><span class="line">            <span class="comment">//LOGI &lt;&lt; &quot;CDatabaseMysql::Query, mysql is abnormal, errno : &quot; &lt;&lt; uErrno;</span></span><br><span class="line">            <span class="keyword">if</span> (CR_SERVER_GONE_ERROR == uErrno)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LOGI &lt;&lt; &quot;CDatabaseMysql::Query, mysql is disconnected!&quot;;</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> == initialize(m_DBInfo.strHost, m_DBInfo.strUser,</span><br><span class="line">                    m_DBInfo.strPwd, m_DBInfo.strDBName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//LOGI &lt;&lt; sql;</span></span><br><span class="line">                iTempRet = mysql_real_query(m_Mysql, sql, <span class="built_in">strlen</span>(sql));</span><br><span class="line">                <span class="keyword">if</span> (iTempRet)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//LOGE &lt;&lt; &quot;SQL: &quot; &lt;&lt; sql ;</span></span><br><span class="line">                    <span class="comment">//LOGE &lt;&lt; &quot;query ERROR: &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;SQL: &quot; &lt;&lt; sql ;</span></span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;query ERROR: &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//LOGI &lt;&lt; &quot;call mysql_store_result&quot;;</span></span><br><span class="line">        result = mysql_store_result(m_Mysql);<span class="comment">//返回mysql查询结果集</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回改变，删除或插入的最后一条语句的行数,对于 SELECT语句，其 mysql_affected_rows()工作方式类似于mysql_num_rows()</span></span><br><span class="line">        rowCount = mysql_affected_rows(m_Mysql);</span><br><span class="line">        <span class="comment">//返回连接上最新查询的列数</span></span><br><span class="line">        fieldCount = mysql_field_count(m_Mysql);</span><br><span class="line">        <span class="comment">// end guarded block</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  if (!rowCount)</span></span><br><span class="line">    <span class="comment">//  &#123;</span></span><br><span class="line">          <span class="comment">//LOGI &lt;&lt; &quot;call mysql_free_result&quot;;</span></span><br><span class="line">    <span class="comment">//      mysql_free_result(result);</span></span><br><span class="line">    <span class="comment">//      return NULL;</span></span><br><span class="line">    <span class="comment">//  &#125;</span></span><br><span class="line"></span><br><span class="line">    QueryResult* queryResult = <span class="keyword">new</span> QueryResult(result, rowCount, fieldCount);</span><br><span class="line"></span><br><span class="line">    queryResult-&gt;nextRow();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queryResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">QueryResult* <span class="title">CDatabaseMysql::pquery</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!format) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="keyword">char</span> szQuery[MAX_QUERY_LEN];</span><br><span class="line">    va_start(ap, format);</span><br><span class="line">    <span class="keyword">int</span> res = vsnprintf(szQuery, MAX_QUERY_LEN, format, ap);</span><br><span class="line">    va_end(ap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//LOGE &lt;&lt; &quot;SQL Query truncated (and not execute) for format: &quot; &lt;&lt; format;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> query(szQuery);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CDatabaseMysql::execute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_Mysql)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> iTempRet = mysql_query(m_Mysql, sql);</span><br><span class="line">        <span class="keyword">if</span> (iTempRet)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> uErrno = mysql_errno(m_Mysql);</span><br><span class="line">            <span class="comment">//LOGI &lt;&lt; &quot;CDatabaseMysql::Query, mysql is abnormal, errno : &quot; &lt;&lt; uErrno;</span></span><br><span class="line">            <span class="keyword">if</span> (CR_SERVER_GONE_ERROR == uErrno)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LOGI &lt;&lt; &quot;CDatabaseMysql::Query, mysql is disconnected!&quot;;</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> == initialize(m_DBInfo.strHost, m_DBInfo.strUser, m_DBInfo.strPwd, m_DBInfo.strDBName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//LOGI &lt;&lt; sql;</span></span><br><span class="line">                iTempRet = mysql_real_query(m_Mysql, sql, <span class="built_in">strlen</span>(sql));</span><br><span class="line">                <span class="keyword">if</span> (iTempRet)</span><br><span class="line">                &#123;</span><br><span class="line">                    LOGE(<span class="string">&quot;sql error: %s, sql: %s&quot;</span>, mysql_error(m_Mysql), sql);</span><br><span class="line">                    <span class="comment">//LOGE &lt;&lt; &quot;query ERROR: &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;SQL: &quot; &lt;&lt; sql;</span></span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;query ERROR: &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">                LOGE(<span class="string">&quot;sql error: %s, sql: %s&quot;</span>, mysql_error(m_Mysql), sql);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CDatabaseMysql::execute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* sql, <span class="keyword">uint32_t</span>&amp; uAffectedCount, <span class="keyword">int</span>&amp; nErrno)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_Mysql)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> iTempRet = mysql_query(m_Mysql, sql);</span><br><span class="line">        <span class="keyword">if</span> (iTempRet)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> uErrno = mysql_errno(m_Mysql);</span><br><span class="line">            <span class="comment">//LOGE &lt;&lt; &quot;CDatabaseMysql::Query, mysql is abnormal, errno : &quot; &lt;&lt; uErrno;</span></span><br><span class="line">            <span class="keyword">if</span> (CR_SERVER_GONE_ERROR == uErrno)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;CDatabaseMysql::Query, mysql is disconnected!&quot;;</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> == initialize(m_DBInfo.strHost, m_DBInfo.strUser,</span><br><span class="line">                    m_DBInfo.strPwd, m_DBInfo.strDBName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//LOGI &lt;&lt; sql;</span></span><br><span class="line">                iTempRet = mysql_query(m_Mysql, sql);</span><br><span class="line">                nErrno = iTempRet;</span><br><span class="line">                <span class="keyword">if</span> (iTempRet)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//LOGE &lt;&lt; &quot;SQL: &quot; &lt;&lt; sql;</span></span><br><span class="line">                    <span class="comment">//LOGE &lt;&lt; &quot;query ERROR: &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;SQL: &quot; &lt;&lt; sql;</span></span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;query ERROR: &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uAffectedCount = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(mysql_affected_rows(m_Mysql));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CDatabaseMysql::pexecute</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!format)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="keyword">char</span> szQuery[MAX_QUERY_LEN];</span><br><span class="line">    va_start(ap, format);</span><br><span class="line">    <span class="keyword">int</span> res = vsnprintf(szQuery, MAX_QUERY_LEN, format, ap);</span><br><span class="line">    va_end(ap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//LOGE &lt;&lt; &quot;SQL Query truncated (and not execute) for format: &quot; &lt;&lt; format;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!m_Mysql)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> iTempRet = mysql_query(m_Mysql, szQuery);</span><br><span class="line">        <span class="keyword">if</span> (iTempRet)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> uErrno = mysql_errno(m_Mysql);</span><br><span class="line">            <span class="comment">//LOGE &lt;&lt; &quot;CDatabaseMysql::Query, mysql is abnormal, errno : &quot; &lt;&lt; uErrno;</span></span><br><span class="line">            <span class="keyword">if</span> (CR_SERVER_GONE_ERROR == uErrno)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;CDatabaseMysql::Query, mysql is disconnected!&quot;;</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> == initialize(m_DBInfo.strHost, m_DBInfo.strUser,</span><br><span class="line">                    m_DBInfo.strPwd, m_DBInfo.strDBName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//LOGI &lt;&lt; szQuery;</span></span><br><span class="line">                iTempRet = mysql_query(m_Mysql, szQuery);</span><br><span class="line">                <span class="keyword">if</span> (iTempRet)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//LOGE &lt;&lt; &quot;SQL: &quot; &lt;&lt; szQuery;</span></span><br><span class="line">                    <span class="comment">//LOGE &lt;&lt; &quot;query ERROR: &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;SQL: &quot; &lt;&lt; szQuery;</span></span><br><span class="line">                <span class="comment">//LOGE &lt;&lt; &quot;query ERROR: &quot; &lt;&lt; mysql_error(m_Mysql);</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CDatabaseMysql::clearStoredResults</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_Mysql)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MYSQL_RES* result = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span> (!mysql_next_result(m_Mysql))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((result = mysql_store_result(m_Mysql)) != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mysql_free_result(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">CDatabaseMysql::getInsertID</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)mysql_insert_id(m_Mysql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">CDatabaseMysql::escapeString</span><span class="params">(<span class="keyword">char</span>* szDst, <span class="keyword">const</span> <span class="keyword">char</span>* szSrc, <span class="keyword">uint32_t</span> uSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//szDst保存语句的容器，szSrc执行语句，uSize：执行语句的长度</span></span><br><span class="line">    <span class="keyword">if</span> (m_Mysql == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (szDst == <span class="literal">NULL</span> || szSrc == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mysql_real_escape_string(m_Mysql, szDst, szSrc, uSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MysqlManager"><a href="#MysqlManager" class="headerlink" title="MysqlManager"></a>MysqlManager</h3><h4 id="MysqlManager-h"><a href="#MysqlManager-h" class="headerlink" title="MysqlManager.h"></a>MysqlManager.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../mysqlapi/DatabaseMysql.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXCMDLEN 8192</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">STableField</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	STableField()&#123;&#125;</span><br><span class="line">	STableField(<span class="built_in">std</span>::<span class="built_in">string</span> strName,<span class="built_in">std</span>::<span class="built_in">string</span> strType,<span class="built_in">std</span>::<span class="built_in">string</span> strIndex):</span><br><span class="line">		m_strName(strName),</span><br><span class="line">		m_strType(strType),</span><br><span class="line">		m_strDesc(strIndex)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> m_strName;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> m_strType;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> m_strDesc;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">STableInfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	STableInfo()&#123;&#125;</span><br><span class="line">	STableInfo(<span class="built_in">std</span>::<span class="built_in">string</span> strName)</span><br><span class="line">		:m_strName(strName)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> m_strName;<span class="comment">//表名</span></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>,STableField&gt; m_mapField;<span class="comment">//string字段名，STableField字段约束语句</span></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> m_strKeyString;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CMysqlManager</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    CMysqlManager(<span class="keyword">void</span>);</span><br><span class="line">    <span class="keyword">virtual</span> ~CMysqlManager(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* host, <span class="keyword">const</span> <span class="keyword">char</span>* user, <span class="keyword">const</span> <span class="keyword">char</span>* pwd, <span class="keyword">const</span> <span class="keyword">char</span>* dbname)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">getHost</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_strHost; &#125;</span><br><span class="line">	<span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">getUser</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_strUser; &#125;</span><br><span class="line">	<span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">getPwd</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_strPassword; &#125;</span><br><span class="line">	<span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">getDBName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_strDataBase; &#125;</span><br><span class="line">	<span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">getCharSet</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_strCharactSet;  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">isDBExist</span><span class="params">()</span></span>;<span class="comment">//判断数据库是否存在</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">createDB</span><span class="params">()</span></span>;<span class="comment">//创建数据库</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">checkTable</span><span class="params">(<span class="keyword">const</span> STableInfo&amp; table)</span></span>;<span class="comment">//判断表是否存在</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">createTable</span><span class="params">(<span class="keyword">const</span> STableInfo&amp; table)</span></span>;<span class="comment">//创建表</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">updateTable</span><span class="params">(<span class="keyword">const</span> STableInfo&amp; table)</span></span>;<span class="comment">//未定义</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;CDatabaseMysql&gt;     m_poConn;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>                         m_strHost;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>                         m_strUser;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>                         m_strPassword;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>                         m_strDataBase;<span class="comment">//数据库</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>                         m_strCharactSet;<span class="comment">//字符编码</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;STableInfo&gt;             m_vecTableInfo;<span class="comment">//创建表的语句容器</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="MysqlManager-cpp"><a href="#MysqlManager-cpp" class="headerlink" title="MysqlManager.cpp"></a>MysqlManager.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MysqlManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../base/AsyncLog.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../base/Singleton.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MysqlThrdMgr.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CMysqlManager::CMysqlManager(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//<span class="doctag">TODO:</span> m_strCharactSet可以放在初始化列表中初始化</span></span><br><span class="line">    m_strCharactSet = <span class="string">&quot;utf8&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化表 </span></span><br><span class="line">	<span class="comment">// 1. t_user </span></span><br><span class="line">	&#123;</span><br><span class="line">		STableInfo info;</span><br><span class="line">		<span class="comment">//name type desc?</span></span><br><span class="line">        info.m_strName = <span class="string">&quot;t_user&quot;</span>;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_id&quot;</span>] = &#123; <span class="string">&quot;f_id&quot;</span>, <span class="string">&quot;bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;自增ID&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_user_id&quot;</span>] = &#123; <span class="string">&quot;f_user_id&quot;</span>, <span class="string">&quot;bigint(20) NOT NULL COMMENT &#x27;用户ID&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_username&quot;</span>] = &#123; <span class="string">&quot;f_username&quot;</span>, <span class="string">&quot;varchar(64) NOT NULL COMMENT &#x27;用户名&#x27;&quot;</span>, <span class="string">&quot;varchar(64)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_nickname&quot;</span>] = &#123; <span class="string">&quot;f_nickname&quot;</span>, <span class="string">&quot;varchar(64) NOT NULL COMMENT &#x27;用户昵称&#x27;&quot;</span>, <span class="string">&quot;varchar(64)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_password&quot;</span>] = &#123; <span class="string">&quot;f_password&quot;</span>, <span class="string">&quot;varchar(64) NOT NULL COMMENT &#x27;用户密码&#x27;&quot;</span>, <span class="string">&quot;varchar(64)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_facetype&quot;</span>] = &#123; <span class="string">&quot;f_facetype&quot;</span>, <span class="string">&quot;int(10) DEFAULT 0 COMMENT &#x27;用户头像类型&#x27;&quot;</span>, <span class="string">&quot;int(10)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_customface&quot;</span>] = &#123; <span class="string">&quot;f_customface&quot;</span>, <span class="string">&quot;varchar(32) DEFAULT NULL COMMENT &#x27;自定义头像名&#x27;&quot;</span>, <span class="string">&quot;varchar(32)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_customfacefmt&quot;</span>] = &#123; <span class="string">&quot;f_customfacefmt&quot;</span>, <span class="string">&quot;varchar(6) DEFAULT NULL COMMENT &#x27;自定义头像格式&#x27;&quot;</span>, <span class="string">&quot;varchar(6)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_gender&quot;</span>] = &#123; <span class="string">&quot;f_gender&quot;</span>, <span class="string">&quot;int(2)  DEFAULT 0 COMMENT &#x27;性别&#x27;&quot;</span>, <span class="string">&quot;int(2)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_birthday&quot;</span>] = &#123; <span class="string">&quot;f_birthday&quot;</span>, <span class="string">&quot;bigint(20)  DEFAULT 19900101 COMMENT &#x27;生日&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_signature&quot;</span>] = &#123; <span class="string">&quot;f_signature&quot;</span>, <span class="string">&quot;varchar(256) DEFAULT NULL COMMENT &#x27;地址&#x27;&quot;</span>, <span class="string">&quot;varchar(256)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_address&quot;</span>] = &#123; <span class="string">&quot;f_address&quot;</span>, <span class="string">&quot;varchar(256) DEFAULT NULL COMMENT &#x27;地址&#x27;&quot;</span>, <span class="string">&quot;varchar(256)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_phonenumber&quot;</span>] = &#123; <span class="string">&quot;f_phonenumber&quot;</span>, <span class="string">&quot;varchar(64) DEFAULT NULL COMMENT &#x27;电话&#x27;&quot;</span>, <span class="string">&quot;varchar(64)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_mail&quot;</span>] = &#123; <span class="string">&quot;f_mail&quot;</span>, <span class="string">&quot;varchar(256) DEFAULT NULL COMMENT &#x27;邮箱&#x27;&quot;</span>, <span class="string">&quot;varchar(256)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_owner_id&quot;</span>] = &#123; <span class="string">&quot;f_owner_id&quot;</span>, <span class="string">&quot;bigint(20) DEFAULT 0 COMMENT &#x27;群账号群主userid&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_teaminfo&quot;</span>] = &#123; <span class="string">&quot;f_teaminfo&quot;</span>, <span class="string">&quot;blob default null comment &#x27;好友分组信息&#x27;&quot;</span>, <span class="string">&quot;blob&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_register_time&quot;</span>] = &#123; <span class="string">&quot;f_register_time&quot;</span>, <span class="string">&quot;datetime NOT NULL COMMENT &#x27;注册时间&#x27;&quot;</span>, <span class="string">&quot;datetime&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_remark&quot;</span>] = &#123; <span class="string">&quot;f_remark&quot;</span>, <span class="string">&quot;varchar(64) NULL COMMENT &#x27;备注&#x27;&quot;</span>, <span class="string">&quot;varchar(64)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_update_time&quot;</span>] = &#123; <span class="string">&quot;f_update_time&quot;</span>, <span class="string">&quot;timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;&quot;</span>, <span class="string">&quot;timestamp&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        info.m_strKeyString = <span class="string">&quot;PRIMARY KEY (f_user_id), INDEX f_user_id (f_user_id), KEY  f_id  ( f_id )&quot;</span>;</span><br><span class="line">        m_vecTableInfo.push_back(info);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//info.m_mapField[&quot;AccountID&quot;] = &#123; &quot;AccountID&quot;, &quot;integer NOT NULL AUTO_INCREMENT PRIMARY KEY&quot;, &quot;int(11)&quot; &#125;;</span></span><br><span class="line">		<span class="comment">//info.m_mapField[&quot;MobilePhone&quot;] = &#123; &quot;MobilePhone&quot;, &quot;bigint NOT NULL&quot;, &quot;bigint(20)&quot; &#125;;</span></span><br><span class="line">		<span class="comment">//info.m_mapField[&quot;NickName&quot;] = &#123; &quot;NickName&quot;, &quot;char(65) not null&quot;, &quot;char(65)&quot; &#125;;</span></span><br><span class="line">		<span class="comment">//info.m_mapField[&quot;PassWord&quot;] = &#123; &quot;PassWord&quot;, &quot;char(65) not null&quot;, &quot;char(65)&quot; &#125;;</span></span><br><span class="line">		<span class="comment">////info.m_mapField[&quot;Friend&quot;] = &#123; &quot;Friend&quot;, &quot;blob not null&quot;, &quot;blob&quot; &#125;;</span></span><br><span class="line">  <span class="comment">//      info.m_mapField[&quot;Friend&quot;] = &#123; &quot;Friend&quot;, &quot;blob default null&quot;, &quot;blob&quot; &#125;;</span></span><br><span class="line">		<span class="comment">//info.m_mapField[&quot;PersonInfo&quot;] = &#123; &quot;PersonInfo&quot;, &quot;blob default null&quot;, &quot;blob&quot; &#125;;</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">//info.m_strKeyString = &quot;UNIQUE KEY(MobilePhone)&quot;;</span></span><br><span class="line">		<span class="comment">//m_vecTableInfo.push_back(info);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. t_user_relationship </span></span><br><span class="line">    &#123;</span><br><span class="line">        STableInfo info;</span><br><span class="line">        <span class="comment">//name type desc?</span></span><br><span class="line">        info.m_strName = <span class="string">&quot;t_user_relationship&quot;</span>;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_id&quot;</span>] = &#123; <span class="string">&quot;f_id&quot;</span>, <span class="string">&quot;bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;自增ID&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_user_id1&quot;</span>] = &#123; <span class="string">&quot;f_user_id1&quot;</span>, <span class="string">&quot;bigint(20) NOT NULL COMMENT &#x27;用户ID&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_user_id2&quot;</span>] = &#123; <span class="string">&quot;f_user_id2&quot;</span>, <span class="string">&quot;bigint(20) NOT NULL COMMENT &#x27;用户ID&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_user1_teamname&quot;</span>] = &#123; <span class="string">&quot;f_user1_teamname&quot;</span>, <span class="string">&quot;VARCHAR(32) NOT NULL DEFAULT &#x27;My Friends&#x27; COMMENT &#x27;用户2在用户1的好友分组名称&#x27;&quot;</span>, <span class="string">&quot;VARCHAR(32)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_user2_teamname&quot;</span>] = &#123; <span class="string">&quot;f_user2_teamname&quot;</span>, <span class="string">&quot;VARCHAR(32) NOT NULL DEFAULT &#x27;My Friends&#x27; COMMENT &#x27;用户1在用户2的好友分组名称&#x27;&quot;</span>, <span class="string">&quot;VARCHAR(32)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_user1_markname&quot;</span>] = &#123; <span class="string">&quot;f_user1_markname&quot;</span>, <span class="string">&quot;VARCHAR(32) COMMENT &#x27;用户2在用户1的备注名称&#x27;&quot;</span>, <span class="string">&quot;VARCHAR(32)&quot;</span> &#125;,</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_user2_markname&quot;</span>] = &#123; <span class="string">&quot;f_user2_markname&quot;</span>, <span class="string">&quot;VARCHAR(32) COMMENT &#x27;用户1在用户2的备注名称&#x27;&quot;</span>, <span class="string">&quot;VARCHAR(32)&quot;</span> &#125;,</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_remark&quot;</span>] = &#123; <span class="string">&quot;f_remark&quot;</span>, <span class="string">&quot;varchar(64) NULL COMMENT &#x27;备注&#x27;&quot;</span>, <span class="string">&quot;varchar(64)&quot;</span> &#125;;</span><br><span class="line">        info.m_mapField[<span class="string">&quot;f_update_time&quot;</span>] = &#123; <span class="string">&quot;f_update_time&quot;</span>, <span class="string">&quot;timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;&quot;</span>, <span class="string">&quot;timestamp&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        info.m_strKeyString = <span class="string">&quot;PRIMARY KEY (f_id), INDEX f_id (f_id)&quot;</span>;</span><br><span class="line">        m_vecTableInfo.push_back(info);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//info.m_mapField[&quot;AccountID&quot;] = &#123; &quot;AccountID&quot;, &quot;integer NOT NULL AUTO_INCREMENT PRIMARY KEY&quot;, &quot;int(11)&quot; &#125;;</span></span><br><span class="line">        <span class="comment">//info.m_mapField[&quot;MobilePhone&quot;] = &#123; &quot;MobilePhone&quot;, &quot;bigint NOT NULL&quot;, &quot;bigint(20)&quot; &#125;;</span></span><br><span class="line">        <span class="comment">//info.m_mapField[&quot;NickName&quot;] = &#123; &quot;NickName&quot;, &quot;char(65) not null&quot;, &quot;char(65)&quot; &#125;;</span></span><br><span class="line">        <span class="comment">//info.m_mapField[&quot;PassWord&quot;] = &#123; &quot;PassWord&quot;, &quot;char(65) not null&quot;, &quot;char(65)&quot; &#125;;</span></span><br><span class="line">        <span class="comment">////info.m_mapField[&quot;Friend&quot;] = &#123; &quot;Friend&quot;, &quot;blob not null&quot;, &quot;blob&quot; &#125;;</span></span><br><span class="line">        <span class="comment">//      info.m_mapField[&quot;Friend&quot;] = &#123; &quot;Friend&quot;, &quot;blob default null&quot;, &quot;blob&quot; &#125;;</span></span><br><span class="line">        <span class="comment">//info.m_mapField[&quot;PersonInfo&quot;] = &#123; &quot;PersonInfo&quot;, &quot;blob default null&quot;, &quot;blob&quot; &#125;;</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//info.m_strKeyString = &quot;UNIQUE KEY(MobilePhone)&quot;;</span></span><br><span class="line">        <span class="comment">//m_vecTableInfo.push_back(info);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. t_chatmsg </span></span><br><span class="line">	&#123;</span><br><span class="line">		STableInfo chat;</span><br><span class="line">		chat.m_strName = <span class="string">&quot;t_chatmsg&quot;</span>;</span><br><span class="line">		chat.m_mapField[<span class="string">&quot;f_id&quot;</span>] = &#123; <span class="string">&quot;f_id&quot;</span>, <span class="string">&quot;bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;自增ID&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">		chat.m_mapField[<span class="string">&quot;f_senderid&quot;</span>] = &#123; <span class="string">&quot;f_senderid&quot;</span>, <span class="string">&quot;bigint(20) NOT NULL COMMENT &#x27;发送者id&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">		chat.m_mapField[<span class="string">&quot;f_targetid&quot;</span>] = &#123; <span class="string">&quot;f_targetid&quot;</span>, <span class="string">&quot;bigint(20) NOT NULL COMMENT &#x27;接收者id&#x27;&quot;</span>, <span class="string">&quot;bigint(20)&quot;</span> &#125;;</span><br><span class="line">        chat.m_mapField[<span class="string">&quot;f_msgcontent&quot;</span>] = &#123; <span class="string">&quot;f_msgcontent&quot;</span>, <span class="string">&quot;BLOB NOT NULL COMMENT &#x27;聊天内容&#x27;&quot;</span>, <span class="string">&quot;BLOB&quot;</span> &#125;;</span><br><span class="line">        chat.m_mapField[<span class="string">&quot;f_create_time&quot;</span>] = &#123; <span class="string">&quot;f_create_time&quot;</span>, <span class="string">&quot;timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;&quot;</span>, <span class="string">&quot;timestamp&quot;</span> &#125;;</span><br><span class="line">        chat.m_mapField[<span class="string">&quot;f_remark&quot;</span>] = &#123; <span class="string">&quot;f_remark&quot;</span>, <span class="string">&quot;varchar(64) NULL COMMENT &#x27;备注&#x27;&quot;</span>, <span class="string">&quot;varchar(64)&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        chat.m_strKeyString = <span class="string">&quot;PRIMARY KEY (f_id), INDEX f_id (f_id)&quot;</span>;</span><br><span class="line">		m_vecTableInfo.push_back(chat);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CMysqlManager::~CMysqlManager(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlManager::init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* host, <span class="keyword">const</span> <span class="keyword">char</span>* user, <span class="keyword">const</span> <span class="keyword">char</span>* pwd, <span class="keyword">const</span> <span class="keyword">char</span>* dbname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_strHost = host;</span><br><span class="line">	m_strUser = user;</span><br><span class="line">    <span class="comment">//数据库密码可能为空</span></span><br><span class="line">    <span class="keyword">if</span> (pwd != <span class="literal">NULL</span>)</span><br><span class="line">	    m_strPassword = pwd;</span><br><span class="line">	m_strDataBase = dbname;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//注意：检查数据库是否存在时，需要将数据库名称设置为空</span></span><br><span class="line">	m_poConn.reset(<span class="keyword">new</span> CDatabaseMysql());</span><br><span class="line">    <span class="keyword">if</span> (!m_poConn-&gt;initialize(m_strHost, m_strUser, m_strPassword, <span class="string">&quot;&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//LOG_FATAL &lt;&lt; &quot;CMysqlManager::Init failed, please check params(&quot; &lt;&lt; m_strHost &lt;&lt; &quot;, &quot; &lt;&lt; m_strUser &lt;&lt; &quot;, &quot; &lt;&lt; m_strPassword &lt;&lt; &quot;)&quot;;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">////////////////////// 1. 检查库是否存在 /////////////////////////</span></span><br><span class="line">	<span class="keyword">if</span> (!isDBExist())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!createDB())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//再次确定是否可以连接上数据库</span></span><br><span class="line">    m_poConn.reset(<span class="keyword">new</span> CDatabaseMysql());</span><br><span class="line">	<span class="keyword">if</span> (!m_poConn-&gt;initialize(m_strHost, m_strUser, m_strPassword, m_strDataBase))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//LOG_FATAL &lt;&lt; &quot;CMysqlManager::Init failed, please check params(&quot; &lt;&lt; m_strHost &lt;&lt; &quot;, &quot; &lt;&lt; m_strUser</span></span><br><span class="line">		<span class="comment">//	&lt;&lt; &quot;, &quot; &lt;&lt; m_strPassword &lt;&lt; &quot;, &quot; &lt;&lt; m_strDataBase &lt;&lt; &quot;)&quot;;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">////////////////////// 2. 检查库中表是否正确 /////////////////////////</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; m_vecTableInfo.size(); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		STableInfo table = m_vecTableInfo[i];</span><br><span class="line">		<span class="keyword">if</span> (!checkTable(table))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//LOG_FATAL &lt;&lt; &quot;CMysqlManager::Init, table check failed : &quot; &lt;&lt; table.m_strName;</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">////////////////////// 2. 检查库中表是否正确 /////////////////////////</span></span><br><span class="line"></span><br><span class="line">    m_poConn.reset();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlManager::isDBExist</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == m_poConn)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	QueryResult* pResult = m_poConn-&gt;query(<span class="string">&quot;show databases&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == pResult)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//LOGI &lt;&lt; &quot;CMysqlManager::_IsDBExist, no database(&quot; &lt;&lt; m_strDataBase &lt;&lt; &quot;)&quot;;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Field* pRow = pResult-&gt;fetch();</span><br><span class="line">	<span class="keyword">while</span> (pRow != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">string</span> name = pRow[<span class="number">0</span>].getString();</span><br><span class="line">		<span class="keyword">if</span> (name == m_strDataBase)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//LOGI &lt;&lt; &quot;CMysqlManager::_IsDBExist, find database(&quot; &lt;&lt; m_strDataBase &lt;&lt; &quot;)&quot;;</span></span><br><span class="line">			pResult-&gt;endQuery();</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (pResult-&gt;nextRow() == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		pRow = pResult-&gt;fetch();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//LOGI &lt;&lt; &quot;CMysqlManager::_IsDBExist, no database(&quot; &lt;&lt; m_strDataBase &lt;&lt; &quot;)&quot;;</span></span><br><span class="line">	pResult-&gt;endQuery();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> pResult;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlManager::createDB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == m_poConn)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint32_t</span> uAffectedCount = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> nErrno = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">stringstream</span> ss;</span><br><span class="line">	ss &lt;&lt; <span class="string">&quot;create database &quot;</span> &lt;&lt; m_strDataBase;</span><br><span class="line">	<span class="keyword">if</span> (m_poConn-&gt;execute(ss.str().c_str(), uAffectedCount, nErrno))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (uAffectedCount == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//LOGI &lt;&lt; &quot;CMysqlManager::_CreateDB, create database &quot; &lt;&lt;</span></span><br><span class="line">			<span class="comment">//	m_strDataBase &lt;&lt; &quot; success&quot;;</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//LOGE &lt;&lt; &quot;CMysqlManager::_CreateDB, create database &quot; &lt;&lt; m_strDataBase &lt;&lt; &quot; failed(&quot;</span></span><br><span class="line">		<span class="comment">//	&lt;&lt; nErrno &lt;&lt; &quot;)&quot;;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlManager::checkTable</span><span class="params">(<span class="keyword">const</span> STableInfo&amp; table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == m_poConn)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (table.m_strName.find_first_not_of(<span class="string">&quot;\t\r\n &quot;</span>) == <span class="built_in">std</span>::<span class="built_in">string</span>::npos)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//LOGW &lt;&lt; &quot;CMysqlManager::_CheckTable, tale info not valid&quot;;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">stringstream</span> ss;</span><br><span class="line">	ss &lt;&lt; <span class="string">&quot;desc &quot;</span> &lt;&lt; table.m_strName;</span><br><span class="line">	QueryResult* pResult = m_poConn-&gt;query(ss.str());</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == pResult)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//LOGI &lt;&lt; &quot;CMysqlManager::_CheckTable, no table&quot; &lt;&lt; table.m_strName &lt;&lt; &quot;, begin create.....&quot;;</span></span><br><span class="line">		<span class="keyword">if</span> (createTable(table))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//LOGI &lt;&lt; &quot;CMysqlManager::_CheckTable, &quot; &lt;&lt; table.m_strName &lt;&lt; &quot;, end create.....&quot;;</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="comment">// 检查字段是否匹配， 暂时只检查是否存在， 还需进一步看类型是否需要修改 </span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; mapOldTable;</span><br><span class="line">		Field* pRow = pResult-&gt;fetch();</span><br><span class="line">		<span class="keyword">while</span> (pRow != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> name = pRow[<span class="number">0</span>].getString();</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> type = pRow[<span class="number">1</span>].getString();</span><br><span class="line">			mapOldTable[name] = type;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (pResult-&gt;nextRow() == <span class="literal">false</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			pRow = pResult-&gt;fetch();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pResult-&gt;endQuery();</span><br><span class="line">        <span class="keyword">delete</span> pResult;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, STableField&gt;::const_iterator it = table.m_mapField.begin();</span><br><span class="line">			it != table.m_mapField.end(); ++it)</span><br><span class="line">		&#123;<span class="comment">//检查字段是否正确</span></span><br><span class="line">			STableField field = it-&gt;second;</span><br><span class="line">			<span class="keyword">if</span> (mapOldTable.find(field.m_strName) == mapOldTable.end())</span><br><span class="line">			&#123;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">stringstream</span> ss;</span><br><span class="line">				ss &lt;&lt; <span class="string">&quot;alter table &quot;</span> &lt;&lt; table.m_strName &lt;&lt; <span class="string">&quot; add column &quot;</span></span><br><span class="line">					&lt;&lt; field.m_strName &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; field.m_strType;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">string</span> sql = ss.str();</span><br><span class="line">				<span class="keyword">if</span> (m_poConn-&gt;execute(sql.c_str()))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//LOGI &lt;&lt; sql;</span></span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//LOGE &lt;&lt; &quot;CMysqlManager::_CheckTable failed : &quot; &lt;&lt; sql;</span></span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlManager::createTable</span><span class="params">(<span class="keyword">const</span> STableInfo&amp; table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (table.m_mapField.size() == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//LOGE &lt;&lt; &quot;CMysqlManager::_CreateTable, table info not valid, &quot; &lt;&lt; table.m_strName;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">stringstream</span> ss;</span><br><span class="line">	ss &lt;&lt; <span class="string">&quot;CREATE TABLE IF NOT EXISTS &quot;</span> &lt;&lt; table.m_strName &lt;&lt; <span class="string">&quot; (&quot;</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, STableField&gt;::const_iterator it = table.m_mapField.begin();</span><br><span class="line">		it != table.m_mapField.end(); ++it)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (it != table.m_mapField.begin())</span><br><span class="line">		&#123;</span><br><span class="line">			ss &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		STableField field = it-&gt;second;</span><br><span class="line">		ss &lt;&lt; field.m_strName &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; field.m_strType;		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (table.m_strKeyString != <span class="string">&quot;&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ss &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; table.m_strKeyString;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ss &lt;&lt; <span class="string">&quot;)default charset = utf8, ENGINE = InnoDB;&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span> (m_poConn-&gt;execute(ss.str().c_str()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    LOGE(<span class="string">&quot;Create table error, sql: %s&quot;</span>, ss.str().c_str());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="有了以上的代码便可以对MySQL数据库进行基本的操作"><a href="#有了以上的代码便可以对MySQL数据库进行基本的操作" class="headerlink" title="有了以上的代码便可以对MySQL数据库进行基本的操作"></a>有了以上的代码便可以对MySQL数据库进行基本的操作</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;./base/AsyncLog.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;./mysqlmgr/MysqlManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;./mysqlapi/DatabaseMysql.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;./base/Singleton.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CMysqlManager &amp;test=Singleton&lt;CMysqlManager&gt;::Instance();<span class="comment">//使用单例模式</span></span><br><span class="line">    test.init(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;55555&quot;</span>,<span class="string">&quot;flmaingo&quot;</span>);<span class="comment">//初始化</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Hello, World!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行流程：</p>
<p>CMysqlManager类在初始化对象时，构造函数设置mysql字符编码=&gt;</p>
<p>并生成3个STableInfo临时结构体来保存建表语句=&gt;</p>
<p>而后将其push进入私有成员变量m_vecTableInfo(std::vector<STableInfo>)中保存，该变量是一个vertor|=&gt;</p>
<p>之后调用init函数进行初始化设置</p>
<p><strong><u>CMysqlManager::init</u></strong>:[初始化成员变量CDatabaseMysql型的指针m_poConn=&gt;而后调用CDatabaseMysql类的initialize函数]=&gt;</p>
<p>**<u>CDatabaseMysql::initialize</u>**函数:[接收MySQL连接所需的数据并接收一个空的数据库名=&gt;</p>
<p>调用mysql提供的api初始化CDatabaseMysql类的成员变量MYSQL类型的指针m_Mysql=&gt;</p>
<p>和mysql服务器建立连接=&gt;</p>
<p>初始化成员变量DatabaseInfo类型结构的m_DBInfo保存mysql的ip,port,dbname,user=&gt;</p>
<p>设置字符编码]=&gt;</p>
<p>initialize函数调用完成返回CMysqlManager::init函数=&gt;</p>
<p>init函数调用isDBExist函数判断数据库是否存在=&gt;</p>
<p><strong><u>CMysqlManager::isDBExist:</u></strong>{[调用CDatabaseMysql成员函数query执行show databases语句返回一个QueryResult类指针=&gt;</p>
<p><strong><u>CDatabaseMysql::query</u></strong>:[返回一个QueryResult指针执行mysql api获取一个mysql查询结果集，并获取mysql结果集的行数，当前处理指针位置=&gt;</p>
<p>利用三个参数构造一个QueryResult类</p>
<p><strong><u>QueryResult::QueryResult</u></strong>:(用传入的列数初始化成员变量 Field *   m_CurrentRow来保存mysql行数据=&gt;</p>
<p>调用mysql相关api获取数据，得到表头，将其存入QueryResult的m_vtFieldNames中)=&gt;</p>
<p>返回CMysqlManager::query函数调用queryResult::nextRow函数获取一行数据=&gt;</p>
<p>**<u>queryResult::nextRow</u>**：(提取结果集中的一行数据存入成员变量m_CurrentRow中)=&gt;</p>
<p>返回CMysqlManager::query函数=&gt;</p>
<p>返回一个queryResult型指针=&gt;</p>
<p>返回CMysqlManager::isDBExist函数=&gt;</p>
<p>获取QueryResult类成员变量m_CurrentRow中保存的mysql数据，取出数据库名和CMysqlManager::m_strDataBase中保存的数据库相比较，如果不匹配调用QueryResult::nextRow函数或许下一行继续比较，直到结果集为空，或者比较相等时结束循环=&gt;</p>
<p>调用QueryResult::endQuery释放mysql结果集，及QueryResult类的相关资源，返回真假以判断表是否存在]=&gt;</p>
<p>返回CMysqlManager::init函数=&gt;</p>
<p>若数据库不存在调用CMysqlManager::createDB函数创建数据库=&gt;</p>
<p>若存在则调用CMysqlManager::checkTable检查表是否存在=&gt;</p>
<p>若不存在则创建，若存在则检查字段是否存在及其类型是否正确若不正确则修改]}=&gt;</p>
<p>返回CMysqlManager::init函数初始化完成=&gt;</p>
<p>若初始化成功则可以调用成员变量std::shared_ptr<CDatabaseMysql>     m_poConn来执行一系列sql操作</p>
<h3 id="MysqlTask"><a href="#MysqlTask" class="headerlink" title="MysqlTask"></a>MysqlTask</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">//MysqlTask.h纯虚类，未实现，提供接口，可以用来做MySQL连接池</span></span><br><span class="line"><span class="keyword">enum</span> EMysqlError</span><br><span class="line">&#123;</span><br><span class="line">    EME_ERROR = <span class="number">-1</span>,</span><br><span class="line">    EME_OK,</span><br><span class="line">    EME_NOT_EXIST,</span><br><span class="line">    EME_EXIST,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CDatabaseMysql</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IMysqlTask</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    IMysqlTask(<span class="keyword">void</span>) &#123;&#125;;</span><br><span class="line">    <span class="keyword">virtual</span> ~IMysqlTask(<span class="keyword">void</span>) &#123;&#125;;<span class="comment">//继承以释放资源</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(CDatabaseMysql* poConn)</span> </span>= <span class="number">0</span>;<span class="comment">//执行sql函数接口，数据库线程( CMysqlThrd::mainLoop)做查询</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">reply</span><span class="params">()</span> </span>= <span class="number">0</span>;<span class="comment">//获取数据接口，逻辑线程(CMysqlThrdMgr::processReplyTask)获取结果</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123; <span class="keyword">delete</span> <span class="keyword">this</span>; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="TaskList"><a href="#TaskList" class="headerlink" title="TaskList"></a>TaskList</h3><h4 id="TaskList-h"><a href="#TaskList-h" class="headerlink" title="TaskList.h"></a>TaskList.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MysqlTask.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_TASK_NUM 1000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTaskList</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    CTaskList();</span><br><span class="line">    ~CTaskList(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">push</span><span class="params">(IMysqlTask* poTask)</span></span>;                  <span class="comment">// 逻辑线程修改 </span></span><br><span class="line">    <span class="function">IMysqlTask* <span class="title">pop</span><span class="params">()</span></span>;				                <span class="comment">// 数据库线程修改 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">uint16_t</span>            m_uReadIndex;               <span class="comment">// 数据库线程修改 </span></span><br><span class="line">	<span class="keyword">uint16_t</span>            m_uWriteIndex;              <span class="comment">// 逻辑线程修改   </span></span><br><span class="line">	IMysqlTask*         m_pTaskNode[MAX_TASK_NUM];  <span class="comment">//一个环形队列，将要执行的MySQL操作，用一个IMysqlTask来保存，而后push进入m_pTaskNode池</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="TaskList-cpp"><a href="#TaskList-cpp" class="headerlink" title="TaskList.cpp"></a>TaskList.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TaskList.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../base/AsyncLog.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CTaskList::CTaskList() : m_uReadIndex(<span class="number">0</span>), m_uWriteIndex(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">memset</span>(m_pTaskNode, <span class="number">0</span>, <span class="keyword">sizeof</span>(m_pTaskNode));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CTaskList::~CTaskList(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_TASK_NUM; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">delete</span> m_pTaskNode[i];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CTaskList::push</span><span class="params">(IMysqlTask* poTask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint16_t</span> usNextIndex = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint16_t</span>&gt;((m_uWriteIndex + <span class="number">1</span>) % MAX_TASK_NUM);</span><br><span class="line">	<span class="keyword">if</span> (usNextIndex == m_uReadIndex)<span class="comment">//池满</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// getchar();</span></span><br><span class="line">		<span class="comment">//LOGE &lt;&lt; &quot;mysql task list full (read : &quot; &lt;&lt; m_uReadIndex &lt;&lt; &quot;, write : &quot; &lt;&lt; m_uWriteIndex &lt;&lt; &quot;)&quot;;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m_pTaskNode[m_uWriteIndex] = poTask;</span><br><span class="line">	m_uWriteIndex = usNextIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">IMysqlTask* <span class="title">CTaskList::pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_uWriteIndex == m_uReadIndex)<span class="comment">//池为空</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	IMysqlTask* pTask = m_pTaskNode[m_uReadIndex];</span><br><span class="line">	m_uReadIndex = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint16_t</span>&gt;((m_uReadIndex + <span class="number">1</span>) % MAX_TASK_NUM);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MysqlThrd"><a href="#MysqlThrd" class="headerlink" title="MysqlThrd"></a>MysqlThrd</h3><h4 id="MysqlThrd-h"><a href="#MysqlThrd-h" class="headerlink" title="MysqlThrd.h"></a>MysqlThrd.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;condition_variable&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../mysqlapi/DatabaseMysql.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MysqlTask.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TaskList.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CMysqlThrd</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    CMysqlThrd(<span class="keyword">void</span>);</span><br><span class="line">    ~CMysqlThrd(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">start</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; host, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; user, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; pwd, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">addTask</span><span class="params">(IMysqlTask* poTask)</span><span class="comment">//向任务队列(sql执行队列)中添加任务</span></span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> m_oTask.push(poTask);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IMysqlTask* <span class="title">getReplyTask</span><span class="params">(<span class="keyword">void</span>)</span><span class="comment">//取出任务执行结果      </span></span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> m_oReplyTask.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">uninit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">bool</span>				                 m_bTerminate;<span class="comment">//线程是否运行标志</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;<span class="built_in">std</span>::thread&gt;         m_pThread;<span class="comment">//线程指针</span></span><br><span class="line">    <span class="keyword">bool</span>                                 m_bStart;<span class="comment">//线程启动标志</span></span><br><span class="line">	CDatabaseMysql*                      m_poConn;<span class="comment">//sql操作类指针</span></span><br><span class="line">    CTaskList                            m_oTask;<span class="comment">//待执行队列</span></span><br><span class="line">    CTaskList                            m_oReplyTask;<span class="comment">//查询结果集队列</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">std</span>::mutex                           mutex_;</span><br><span class="line">	<span class="built_in">std</span>::condition_variable              cond_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="MysqlThrd-cpp"><a href="#MysqlThrd-cpp" class="headerlink" title="MysqlThrd.cpp"></a>MysqlThrd.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MysqlThrd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt; //for std::bind</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../base/AsyncLog.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CMysqlThrd::CMysqlThrd(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	m_bTerminate	= <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    m_bStart        = <span class="literal">false</span>;</span><br><span class="line">    m_poConn        = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CMysqlThrd::~CMysqlThrd(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMysqlThrd::Run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mainLoop();</span><br><span class="line">	uninit();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> != m_pThread)</span><br><span class="line">	&#123;</span><br><span class="line">		m_pThread-&gt;join();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlThrd::start</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; host, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; user, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; pwd, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_poConn = <span class="keyword">new</span> CDatabaseMysql();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == m_poConn)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//LOG_FATAL &lt;&lt; &quot;CMysqlThrd::Start, Cannot open database&quot;;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (m_poConn-&gt;initialize(host, user, pwd, dbname) == <span class="literal">false</span>)<span class="comment">//连接数据库</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMysqlThrd::stop</span><span class="params">()</span><span class="comment">//停止数据库线程</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_bTerminate)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m_bTerminate = <span class="literal">true</span>;</span><br><span class="line">	m_pThread-&gt;join();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlThrd::init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_bStart)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动线程</span></span><br><span class="line">	m_pThread.reset(<span class="keyword">new</span> <span class="built_in">std</span>::thread(<span class="built_in">std</span>::bind(&amp;CMysqlThrd::mainLoop, <span class="keyword">this</span>)));<span class="comment">//启动数据库执行线程，并阻塞等待其启动成功后返回</span></span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">		<span class="keyword">while</span> (m_bStart == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cond_.wait(lock);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMysqlThrd::uninit</span><span class="params">()</span><span class="comment">//释放资源转移到了CMysqlThrdMgr::processReplyTask，该函数调用，纯虚类的release函数释放资源</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//m_poConn-&gt;Close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMysqlThrd::mainLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_bStart = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">		cond_.notify_all();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    IMysqlTask* poTask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(!m_bTerminate)<span class="comment">//不停的从执行队列中取出SQL执行，而后将结果push到查询好的结果集中</span></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">NULL</span> != (poTask = m_oTask.pop()))<span class="comment">//从逻辑线程产生的SQL执行队列中取出一个来执行SQL</span></span><br><span class="line">        &#123;</span><br><span class="line">            poTask-&gt;execute(m_poConn);</span><br><span class="line">            m_oReplyTask.push(poTask);<span class="comment">//放入查询好的结果集到队列，以供逻辑线程获取</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::milliseconds(<span class="number">1000</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MysqlThrdMgr"><a href="#MysqlThrdMgr" class="headerlink" title="MysqlThrdMgr"></a>MysqlThrdMgr</h3><h4 id="MysqlThrdMgr-h"><a href="#MysqlThrdMgr-h" class="headerlink" title="MysqlThrdMgr.h"></a>MysqlThrdMgr.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MysqlTask.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MysqlThrd.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CMysqlThrdMgr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    CMysqlThrdMgr(<span class="keyword">void</span>);</span><br><span class="line">    <span class="keyword">virtual</span> ~CMysqlThrdMgr(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">init</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; host, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; user, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; pwd, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">addTask</span><span class="params">(<span class="keyword">uint32_t</span> dwHashID, IMysqlTask* poTask)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">addTask</span><span class="params">(IMysqlTask* poTask)</span> </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> m_aoMysqlThreads[m_dwThreadsCount].addTask(poTask); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">uint32_t</span> <span class="title">getTableHashID</span><span class="params">(<span class="keyword">uint32_t</span> dwHashID)</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">//选择线程</span></span><br><span class="line">        <span class="keyword">return</span> dwHashID % m_dwThreadsCount; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">processReplyTask</span><span class="params">(<span class="keyword">int32_t</span> nCount)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">getThreadsCount</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> m_dwThreadsCount; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> m_dwThreadsCount = <span class="number">9</span>;<span class="comment">//用于hash选择线程，所以比线程数少了一，但取模能取0-9十个</span></span><br><span class="line">	CMysqlThrd            m_aoMysqlThreads[m_dwThreadsCount+<span class="number">1</span>];<span class="comment">//逻辑线程队列，循环队列</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="MysqlThrdMgr-cpp"><a href="#MysqlThrdMgr-cpp" class="headerlink" title="MysqlThrdMgr.cpp"></a>MysqlThrdMgr.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MysqlThrdMgr.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../base/AsyncLog.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CMysqlThrdMgr::CMysqlThrdMgr(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CMysqlThrdMgr::~CMysqlThrdMgr(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlThrdMgr::addTask</span><span class="params">( <span class="keyword">uint32_t</span> dwHashID, IMysqlTask* poTask )</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//添加任务</span></span><br><span class="line">    <span class="comment">//LOG_DEBUG &lt;&lt; &quot;CMysqlThrdMgr::AddTask, HashID = &quot; &lt;&lt; dwHashID;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> btIndex = getTableHashID(dwHashID);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (btIndex &gt;= m_dwThreadsCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m_aoMysqlThreads[btIndex].addTask(poTask);<span class="comment">//选择0-9号线程中的一个添加任务</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlThrdMgr::init</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; host, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; user, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; pwd, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; dbname)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//启动10个任务线程(逻辑线程)</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; m_dwThreadsCount+<span class="number">1</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> == m_aoMysqlThreads[i].start(host, user, pwd, dbname))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CMysqlThrdMgr::processReplyTask</span><span class="params">(<span class="keyword">int32_t</span> nCount )</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//取出任务执行结果</span></span><br><span class="line">    <span class="keyword">bool</span> bResult = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; m_dwThreadsCount + <span class="number">1</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        IMysqlTask* poTask = m_aoMysqlThreads[i].getReplyTask();</span><br><span class="line">		<span class="keyword">int32_t</span> dwProcessedNbr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (((nCount == <span class="number">-1</span>) || (dwProcessedNbr &lt; nCount)) &amp;&amp; (<span class="literal">NULL</span> != poTask))</span><br><span class="line">        &#123;</span><br><span class="line">            poTask-&gt;reply();</span><br><span class="line">            poTask-&gt;release();<span class="comment">//释放资源，释放CMysqlThrd::m_poConn指针</span></span><br><span class="line">            poTask = m_aoMysqlThreads[i].getReplyTask();</span><br><span class="line">            ++dwProcessedNbr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dwProcessedNbr == nCount)</span><br><span class="line">        &#123;</span><br><span class="line">            bResult = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="大致思想"><a href="#大致思想" class="headerlink" title="大致思想"></a>大致思想</h4><p>一个数据库执行线程，10个逻辑线程。逻辑线程只负责添加任务和取出任务执行结果，数据库执行线程负责调用</p>
<p>纯虚类(IMysqlTask)的函数执行任务，并将结果放入结果队列当中</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Cpp/" rel="tag"> <i class="fa fa-tag"></i>Cpp</a>
              <a href="/tags/mysql/" rel="tag"> <i class="fa fa-tag"></i>mysql</a>
              <a href="/tags/Flamingo/" rel="tag"> <i class="fa fa-tag"></i>Flamingo</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/b159982d/" rel="prev" title="Cpp指针和引用的区别">
      <i class="fa fa-chevron-left"></i> Cpp指针和引用的区别
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/82dd0668/" rel="next" title="Cpp标准库多线程编程">
      Cpp标准库多线程编程 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC80OTUxMy8yNjAwNA=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#MySQL%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3-https-dev-mysql-com-doc-refman-5-7-en-mysql-query-html"><span class="nav-number">1.</span> <span class="nav-text">MySQL官方文档:https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;mysql-query.html</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Field%E7%B1%BB"><span class="nav-number"></span> <span class="nav-text">Field类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Field-h"><span class="nav-number">1.</span> <span class="nav-text">Field.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Field-cpp"><span class="nav-number">2.</span> <span class="nav-text">Field.cpp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QueryResult%E7%B1%BB"><span class="nav-number"></span> <span class="nav-text">QueryResult类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#QueryResult-h"><span class="nav-number">1.</span> <span class="nav-text">QueryResult.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QueryResult-cpp"><span class="nav-number">2.</span> <span class="nav-text">QueryResult.cpp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DatabaseMysql"><span class="nav-number"></span> <span class="nav-text">DatabaseMysql</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DatabaseMysql-h"><span class="nav-number">1.</span> <span class="nav-text">DatabaseMysql.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DatabaseMysql-cpp"><span class="nav-number">2.</span> <span class="nav-text">DatabaseMysql.cpp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MysqlManager"><span class="nav-number"></span> <span class="nav-text">MysqlManager</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MysqlManager-h"><span class="nav-number">1.</span> <span class="nav-text">MysqlManager.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MysqlManager-cpp"><span class="nav-number">2.</span> <span class="nav-text">MysqlManager.cpp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E4%BA%86%E4%BB%A5%E4%B8%8A%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BE%BF%E5%8F%AF%E4%BB%A5%E5%AF%B9MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E5%9F%BA%E6%9C%AC%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number"></span> <span class="nav-text">有了以上的代码便可以对MySQL数据库进行基本的操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MysqlTask"><span class="nav-number"></span> <span class="nav-text">MysqlTask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TaskList"><span class="nav-number"></span> <span class="nav-text">TaskList</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TaskList-h"><span class="nav-number">1.</span> <span class="nav-text">TaskList.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TaskList-cpp"><span class="nav-number">2.</span> <span class="nav-text">TaskList.cpp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MysqlThrd"><span class="nav-number"></span> <span class="nav-text">MysqlThrd</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MysqlThrd-h"><span class="nav-number">1.</span> <span class="nav-text">MysqlThrd.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MysqlThrd-cpp"><span class="nav-number">2.</span> <span class="nav-text">MysqlThrd.cpp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MysqlThrdMgr"><span class="nav-number"></span> <span class="nav-text">MysqlThrdMgr</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MysqlThrdMgr-h"><span class="nav-number">1.</span> <span class="nav-text">MysqlThrdMgr.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MysqlThrdMgr-cpp"><span class="nav-number">2.</span> <span class="nav-text">MysqlThrdMgr.cpp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%A7%E8%87%B4%E6%80%9D%E6%83%B3"><span class="nav-number">3.</span> <span class="nav-text">大致思想</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="allhw"
      src="/images/1.jpg">
  <p class="site-author-name" itemprop="name">allhw</p>
  <div class="site-description" itemprop="description">logs for me</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wxl2" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wxl2" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:allhw@foxmail.com" title="E-Mail → mailto:allhw@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://zgao.top/" title="https:&#x2F;&#x2F;zgao.top" rel="noopener" target="_blank">zgao</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">allhw</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">156k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">2:22</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
